{% extends 'base.html' %}
{% block content %}

<h2>Checkout</h2>

{% if cart %}
<table>
  <thead><tr><th>Izdelek</th><th>Količina</th><th>Cena</th></tr></thead>
  <tbody>
    {% for item in cart %}
    <tr>
      <td>{{ item.product_name }}</td>
      <td>{{ item.quantity }}</td>
      <td>{{ item.total_price }}€</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<form id="checkout-form">
  {% csrf_token %}
  <label>Email:</label><br>
  <input type="email" name="email" required><br><br>

  <label>Naslov:</label><br>
  <textarea name="address" required></textarea><br><br>

  <label>Telefon:</label><br>
  <input type="text" name="phone" required><br><br>

  <button type="submit">Nadaljuj na plačilo</button>
</form>

<script>
document.getElementById('checkout-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const response = await fetch("{% url 'create_payment_intent' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
    },
    body: formData,
  });
  const data = await response.json();
  if (data.client_secret && data.order_id) {
    window.location.href = `/stripe_pay/?client_secret=${data.client_secret}&order_id=${data.order_id}`;
  } else {
    alert(data.error || 'Napaka pri ustvarjanju plačila');
  }
});
</script>

{% else %}
<p>Košarica je prazna.</p>
{% endif %}

{% endblock %}