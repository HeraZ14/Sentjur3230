{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="h1" style="color: #dcdcdc;">Čvekaj s sebi enakimi</div>
<div class="poll-container" style="text-align: center;color: #dcdcdc;">
     <div style="text-align: left;">
<form method="post" id="mainForm" method="post" action="{% url 'forum' %}">
    {% csrf_token %}
    <div class="form-group-floating">
        <textarea  name="content" class="input-floating" style="resize: none;" rows="5" placeholder=" " required></textarea>
        <label>Začni lajež</label>
    </div>
    <input type="hidden" name="captcha_answer" id="captchaHidden">
    <button class="signin_button" type="submit">Začni lajat</button>
</form>
         </div>
    <div id="captchaModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
  <div style="background:#8e1c1c; margin:10% auto; padding:20px; width:300px; border-radius:8px; text-align:center;">
    <p>Da lahko prisostvuješ laježu, dokaži, da si Šentjurčan</p>
    <label id="captchaQuestion">{{ captcha_question }}</label>
    <input type="text" id="captchaInput" autocomplete="off" />
    <div id="captchaError" style="color:#28ec10; display:none; margin-top:10px;">Narobe bimbo!</div>
      {% for error in form.content.errors %}
      <div class="error">{{ error }}</div>
    {% endfor %}
    <button type="button" id="captchaSubmit">Potrdi</button>
    <button type="button" id="captchaCancel">Prekliči</button>
  </div>
</div>

{% for comment in top_level_comments %}
<div class="poll-container" style="background-color:#333;">
    <div style="text-align: left;">
        <hr>
        <strong>@{{ comment.created_by|default:'Anonymous' }} </strong>
        <small style="color: #777676">{{ comment.created_at }}</small><br>
        {{ comment.content }}

        <!-- Voting for top-level comment -->
        <div>
            <button class="vote-button upvote {% if comment.user_vote == 1 %}active{% endif %}" data-id="{{ comment.id }}" data-vote="1">▲</button>
            <span id="score-{{ comment.id }}">{{ comment.vote_score }}</span>
            <button class="vote-button downvote {% if comment.user_vote == -1 %}active{% endif %}" data-id="{{ comment.id }}" data-vote="-1">▼</button>
            <a href="#" style="color: #777676;" onclick="toggleReplyForm({{ comment.id }}); return false;">Laji nazaj</a>
        </div>

        <!-- Replies -->
        {% for reply in comment.replies_list %}
            <div style="margin-left: 2rem; margin-top: 10px;">
                <strong>@{{ reply.created_by|default:'Anonymous' }} </strong>
                <small style="color: #777676;">{{ reply.created_at }}</small><br>
                {{ reply.content }}

                <!-- Voting for reply -->
                <div>
                    <button class="vote-button upvote {% if reply.user_vote == 1 %}active{% endif %}" data-id="{{ reply.id }}" data-vote="1">▲</button>
                    <span id="score-{{ reply.id }}">{{ reply.vote_score }}</span>
                    <button class="vote-button downvote {% if reply.user_vote == -1 %}active{% endif %}" data-id="{{ reply.id }}" data-vote="-1">▼</button>
                </div>
            </div>
        {% endfor %}

        <!-- Hidden reply form (ni spreminjano) -->
        <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 10px;">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="parent" value="{{ comment.id }}">

                <div class="form-group-floating">
                    <textarea name="content" class="input-floating" style="resize: none;" rows="3" placeholder=" " required></textarea>
                    <label>Odgovor</label>
                </div>

                <button class="signin_button" type="submit">Laji nazaj</button>
            </form>
        </div>
    </div>
</div>
{% empty %}
    <p>Ni še komentarjev.</p>
{% endfor %}

</div>
{% endblock %}
{% block scripts %}
<script>
    let activeForm = null;

    function toggleReplyForm(commentId) {
        const form = document.getElementById('reply-form-' + commentId);
        form.style.display = (form.style.display === 'none') ? 'block' : 'none';
    }

    // Intercept all forms with a textarea
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const textarea = form.querySelector('textarea');
            if (!textarea) return; // safety check

            // Prepreči takojšen submit
            e.preventDefault();

            activeForm = form;
            document.getElementById('captchaModal').style.display = 'block';
            document.getElementById('captchaInput').value = '';  // reset
            document.getElementById('captchaError').style.display = 'none';
        });
    });

    // Cancel captcha
    document.getElementById('captchaCancel').addEventListener('click', function() {
        document.getElementById('captchaModal').style.display = 'none';
    });

    // Confirm captcha
    document.getElementById('captchaSubmit').addEventListener('click', function () {
        const userAnswer = document.getElementById('captchaInput').value.trim().toLowerCase();
        const validAnswers = {{ valid_answers_json|safe }};
        const userWords = userAnswer.split(/\s+/);
        const allWordsValid = userWords.every(word => validAnswers.includes(word));

        if (allWordsValid) {
            const captchaInput = activeForm.querySelector('[name="captcha_answer"]');

            if (captchaInput) {
                captchaInput.value = userAnswer;
            } else {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'captcha_answer';
                hidden.value = userAnswer;
                activeForm.appendChild(hidden);
            }

            document.getElementById('captchaModal').style.display = 'none';
            activeForm.submit();
        } else {
            document.getElementById('captchaError').style.display = 'block';
        }
    });
    document.querySelectorAll('.vote-button').forEach(button => {
    button.addEventListener('click', function () {
        const commentId = this.getAttribute('data-id');
        const vote = parseInt(this.getAttribute('data-vote'));

        const controls = this.parentElement;  // gumbi + score so v istem parentu
        const upBtn = controls.querySelector('.vote-button.upvote');
        const downBtn = controls.querySelector('.vote-button.downvote');

        const isUpActive = upBtn.classList.contains('active');
        const isDownActive = downBtn.classList.contains('active');

        let finalVote = vote;
        if ((vote === 1 && isUpActive) || (vote === -1 && isDownActive)) {
            finalVote = 0;  // odklop glasovanja
        }

        fetch("{% url 'vote_comment' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `comment_id=${commentId}&vote=${finalVote}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.score !== undefined) {
                document.getElementById(`score-${commentId}`).innerText = data.score;

                // počisti obstoječe stanje
                upBtn.classList.remove('active');
                downBtn.classList.remove('active');

                // aktiviraj novega (če ni odstranjen)
                if (finalVote === 1) {
                    upBtn.classList.add('active');
                } else if (finalVote === -1) {
                    downBtn.classList.add('active');
                }
            }
        });
    });
});

</script>
{% endblock %}
